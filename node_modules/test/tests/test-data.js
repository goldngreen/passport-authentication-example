

const assert = require('assert');

const Database = require('server/data').Database;
const userTestData = require('test/services/test-data').user;

describe('sqlite3', () => {

    describe('database', function() {
        const testDatabase = '.data/test.sqlite';
        const addTestData = async (models, count) => {
            const items = await userTestData.samples(count);
            items.forEach((user) => {
                models.users.create(user);
            });
        }
          
        it('should connect to the database', function() {
            const database = new Database(testDatabase);
            assert.ok(database);
            assert.ok(database.db);
            assert.ok(database.db.config);
            assert.ok(database.db.connectionManager);
            assert.ok(database.db.queryInterface);
        });

        it('should authenticate against the database', () => {
            const database = new Database(testDatabase);
            return database.authenticate();
        });

        it('should set up the schema', async function() {
            const database = new Database(testDatabase);
            const models = await database.initSchema();
            assert.ok(models.users);
            assert.ok(models.users.name);
            assert.ok(models.users.tableName);
            assert.strictEqual(models.users.tableName, "users");
        });

        it('should store users', async function() {
            const database = new Database(testDatabase);
            const models = await database.initSchema();
            return models.users.sync({force: true}) // Test: use 'force: true' to drop the table and create again
            .then(() => {
                addTestData(models, 10);
            });
        });

        it('should find all users', async function() {
            const database = new Database(testDatabase);
            const models = await database.initSchema();
            const testUserCount = 100;
            return models.users.sync({force: true}) // Test: use 'force: true' to drop the table and create again
            .then( () => {        
                addTestData(models, testUserCount)
                .then( () => {
                    return models.users.findAll()
                    .then((users) => {
                        assert.strictEqual(users.length, testUserCount);
                    });
                });
            });
        });
    });
});